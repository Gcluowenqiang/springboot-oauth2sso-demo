# çœŸæ­£çš„å•ç‚¹ç™»å‡ºï¼ˆSingle Sign-Outï¼‰å®ç°æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†åœ¨Spring Boot OAuth2å•ç‚¹ç™»å½•ç³»ç»Ÿä¸­å®ç°çœŸæ­£å•ç‚¹ç™»å‡ºçš„å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ä»¤ç‰Œæ’¤é”€ã€ä¼šè¯åŒæ­¥ã€è·¨åŸŸåè°ƒå’ŒWebSocketå®æ—¶é€šçŸ¥å››å¤§æ ¸å¿ƒåŠŸèƒ½ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. ä»¤ç‰Œæ’¤é”€æœºåˆ¶ (Token Revocation)

#### æŠ€æœ¯å®ç°
```java
@Service
public class OAuth2TokenService {
    
    /**
     * æ’¤é”€GitHub Access Token
     * è°ƒç”¨GitHub APIåˆ é™¤åº”ç”¨ä»¤ç‰Œæˆæƒ
     */
    public boolean revokeGitHubToken(String accessToken) {
        String revokeUrl = "https://api.github.com/applications/" + clientId + "/token";
        
        HttpHeaders headers = new HttpHeaders();
        headers.setBasicAuth(clientId, clientSecret);
        headers.setContentType(MediaType.APPLICATION_JSON);
        
        Map<String, String> body = Map.of("access_token", accessToken);
        ResponseEntity<String> response = restTemplate.exchange(
            revokeUrl, HttpMethod.DELETE, new HttpEntity<>(body, headers), String.class);
        
        return response.getStatusCode() == HttpStatus.NO_CONTENT;
    }
}
```

#### å…³é”®ç‰¹æ€§
- **æ ‡å‡†åŒ–APIè°ƒç”¨**: éµå¾ªGitHub OAuth2ä»¤ç‰Œæ’¤é”€æ ‡å‡†
- **å®‰å…¨è®¤è¯**: ä½¿ç”¨Basic Authè¿›è¡Œåº”ç”¨è®¤è¯
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- **ä»¤ç‰Œé®è”½**: æ•æ„Ÿä¿¡æ¯åœ¨æ—¥å¿—ä¸­å®‰å…¨å¤„ç†

### 2. ä¼šè¯åŒæ­¥é€šçŸ¥ (Session Synchronization)

#### æ¶æ„è®¾è®¡
```java
@Service
public class SessionSyncService {
    
    // ç”¨æˆ·ä¼šè¯æ˜ å°„è¡¨
    private final Map<String, Set<String>> userSessionMap = new ConcurrentHashMap<>();
    
    // ä¼šè¯å…ƒæ•°æ®å­˜å‚¨
    private final Map<String, SessionMetadata> sessionMetadataMap = new ConcurrentHashMap<>();
    
    /**
     * æ‰§è¡Œå•ç‚¹ç™»å‡º
     * æ¸…é™¤ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯ï¼Œå®ç°çœŸæ­£çš„å•ç‚¹ç™»å‡º
     */
    public LogoutResult performSingleSignOut(String username, String currentSessionId) {
        // 1. è·å–ç”¨æˆ·æ‰€æœ‰ä¼šè¯
        Set<String> userSessions = userSessionMap.get(username);
        
        // 2. é€ä¸ªä½¿ä¼šè¯å¤±æ•ˆ
        for (String sessionId : userSessions) {
            expireSession(sessionId);
            logoutNotificationService.sendLogoutNotification(sessionId, username, "å•ç‚¹ç™»å‡º");
        }
        
        // 3. æ¸…ç†æ˜ å°„å…³ç³»
        userSessionMap.remove(username);
        
        return result;
    }
}
```

#### æ ¸å¿ƒç‰¹ç‚¹
- **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ConcurrentHashMapç¡®ä¿å¹¶å‘å®‰å…¨
- **ä¼šè¯è·Ÿè¸ª**: ç»´æŠ¤ç”¨æˆ·ä¸ä¼šè¯çš„å®Œæ•´æ˜ å°„å…³ç³»
- **å…ƒæ•°æ®ç®¡ç†**: å­˜å‚¨ä¼šè¯åˆ›å»ºæ—¶é—´ã€ä»¤ç‰Œç­‰å…³é”®ä¿¡æ¯
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡ä¼šè¯å¤±æ•ˆå¤„ç†

### 3. è·¨åŸŸç™»å‡ºåè°ƒ (Cross-Domain Logout Coordination)

#### ç™»å‡ºç±»å‹å¯¹æ¯”

| ç™»å‡ºç±»å‹ | æœ¬åœ°ä¼šè¯ | å…¶ä»–ä¼šè¯ | OAuth2ä»¤ç‰Œ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|------------|----------|
| æœ¬åœ°ç™»å‡º | âœ… æ¸…é™¤ | âŒ ä¿ç•™ | âŒ ä¿ç•™ | å¿«é€Ÿåˆ‡æ¢ç”¨æˆ· |
| å®Œæ•´ç™»å‡º | âœ… æ¸…é™¤ | âœ… æ¸…é™¤ | âŒ ä¿ç•™ | å¸¸è§„å®‰å…¨è¦æ±‚ |
| å…¨å±€ç™»å‡º | âœ… æ¸…é™¤ | âœ… æ¸…é™¤ | âœ… æ’¤é”€ | æœ€é«˜å®‰å…¨çº§åˆ« |

### 4. WebSocketå®æ—¶é€šçŸ¥ (Real-time Notification)

#### WebSocketé…ç½®
```java
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    
    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(logoutWebSocketHandler, "/ws/logout")
                .setAllowedOrigins("*")
                .withSockJS(); // æ”¯æŒSockJSé™çº§
    }
}
```

#### å‰ç«¯WebSocketé›†æˆ
```javascript
const websocket = {
    connection: null,
    
    init() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/logout`;
        
        this.connection = new WebSocket(wsUrl);
        
        this.connection.onmessage = (event) => {
            const notification = JSON.parse(event.data);
            this.handleNotification(notification);
        };
    },
    
    handleNotification(notification) {
        switch (notification.type) {
            case 'FORCE_LOGOUT':
                this.handleForceLogout(notification);
                break;
            case 'BROADCAST_LOGOUT':
                this.handleBroadcastLogout(notification);
                break;
        }
    }
};
```

---

## ğŸ”§ è¯¦ç»†å®ç°æµç¨‹

### å•ç‚¹ç™»å‡ºå®Œæ•´æµç¨‹

1. **ç”¨æˆ·è§¦å‘ç™»å‡º**
   ```
   ç”¨æˆ·é€‰æ‹©ç™»å‡ºç±»å‹ (æœ¬åœ°/å®Œæ•´/å…¨å±€)
   â†“
   å‰ç«¯å‘é€ç™»å‡ºè¯·æ±‚åˆ° /sso/api/logout
   â†“
   åç«¯æ ¹æ®ç±»å‹æ‰§è¡Œç›¸åº”ç™»å‡ºé€»è¾‘
   ```

2. **ä¼šè¯å¤„ç†é˜¶æ®µ**
   ```
   SessionSyncService.performSingleSignOut()
   â†“
   éå†ç”¨æˆ·æ‰€æœ‰æ´»è·ƒä¼šè¯
   â†“
   é€ä¸ªè°ƒç”¨SessionRegistry.expireSession()
   â†“
   å‘é€WebSocketé€šçŸ¥åˆ°å¯¹åº”ä¼šè¯
   ```

3. **ä»¤ç‰Œæ’¤é”€é˜¶æ®µ**ï¼ˆä»…å…¨å±€ç™»å‡ºï¼‰
   ```
   OAuth2TokenService.revokeGitHubToken()
   â†“
   è°ƒç”¨GitHub APIåˆ é™¤ä»¤ç‰Œæˆæƒ
   â†“
   è¿”å›æ’¤é”€ç»“æœ
   ```

4. **å®æ—¶é€šçŸ¥é˜¶æ®µ**
   ```
   LogoutNotificationService.sendLogoutNotification()
   â†“
   é€šè¿‡WebSocketå‘é€JSONé€šçŸ¥
   â†“
   å‰ç«¯æ¥æ”¶å¹¶å¤„ç†å¼ºåˆ¶ç™»å‡º
   ```

---

## ğŸ”’ å®‰å…¨æœºåˆ¶è®¾è®¡

### 1. ä¼šè¯å®‰å…¨
```java
// ä¼šè¯å›ºåŒ–æ”»å‡»ä¿æŠ¤
.sessionManagement(session -> session
    .sessionFixation().changeSessionId()  // ç™»å½•åæ›´æ”¹ä¼šè¯ID
    .maximumSessions(5)                   // é™åˆ¶æœ€å¤§ä¼šè¯æ•°
    .sessionRegistry(sessionRegistry())   // æ³¨å†Œä¼šè¯ç®¡ç†å™¨
)
```

### 2. ä»¤ç‰Œå®‰å…¨
- **åŸºç¡€è®¤è¯**: ä½¿ç”¨GitHub Appçš„Client IDå’ŒSecret
- **HTTPSè¦æ±‚**: ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶HTTPSé€šä¿¡
- **ä»¤ç‰Œé®è”½**: æ—¥å¿—ä¸­é®è”½æ•æ„Ÿä»¤ç‰Œä¿¡æ¯
- **è¶…æ—¶å¤„ç†**: è®¾ç½®åˆç†çš„APIè°ƒç”¨è¶…æ—¶

### 3. WebSocketå®‰å…¨
- **è®¤è¯éªŒè¯**: å»ºç«‹è¿æ¥æ—¶éªŒè¯ç”¨æˆ·èº«ä»½
- **è·¨åŸŸæ§åˆ¶**: ç”Ÿäº§ç¯å¢ƒé™åˆ¶å…è®¸çš„Origin
- **æ¶ˆæ¯éªŒè¯**: éªŒè¯WebSocketæ¶ˆæ¯æ ¼å¼å’Œå†…å®¹
- **è¿æ¥æ¸…ç†**: è‡ªåŠ¨æ¸…ç†æ— æ•ˆå’Œè¿‡æœŸè¿æ¥

---

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

### 1. å…³é”®æŒ‡æ ‡ç›‘æ§
- **ä¼šè¯æ•°é‡**: å®æ—¶ç›‘æ§æ´»è·ƒä¼šè¯æ•°é‡
- **ç™»å‡ºæˆåŠŸç‡**: ç»Ÿè®¡å„ç±»å‹ç™»å‡ºçš„æˆåŠŸç‡
- **WebSocketè¿æ¥æ•°**: ç›‘æ§å®æ—¶è¿æ¥çŠ¶æ€
- **APIå“åº”æ—¶é—´**: GitHub APIè°ƒç”¨æ€§èƒ½

### 2. æ—¥å¿—è®°å½•
```java
// æ“ä½œæ—¥å¿—
logger.info("æ‰§è¡Œå•ç‚¹ç™»å‡º: username={}, sessionCount={}, type={}", 
           username, sessionCount, logoutType);

// å®‰å…¨æ—¥å¿—
securityLogger.warn("å¼ºåˆ¶ç™»å‡ºæ‰§è¡Œ: username={}, reason={}, sourceIP={}", 
                   username, reason, clientIP);

// æ€§èƒ½æ—¥å¿—
performanceLogger.debug("ç™»å‡ºæ“ä½œè€—æ—¶: {}ms, ä¼šè¯æ•°: {}", 
                       duration, expiredSessionCount);
```

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. è®¿é—®å•ç‚¹ç™»å‡ºåŠŸèƒ½
- **URL**: `/sso/logout`
- **å‰ç«¯é›†æˆ**: é¡µé¢è‡ªåŠ¨æ·»åŠ "å•ç‚¹ç™»å‡º"æŒ‰é’®
- **APIæ¥å£**: `/sso/api/logout` (POST)

### 2. ç™»å‡ºç±»å‹é€‰æ‹©
- **ä»…æœ¬åœ°ç™»å‡º**: é€‚ç”¨äºå¿«é€Ÿåˆ‡æ¢ç”¨æˆ·åœºæ™¯
- **å®Œæ•´ç™»å‡º**: æ¨èé€‰é¡¹ï¼Œæ¸…é™¤æ‰€æœ‰ä¼šè¯ä½†ä¿ç•™æˆæƒ
- **å…¨å±€ç™»å‡º**: æœ€é«˜å®‰å…¨çº§åˆ«ï¼Œå®Œå…¨æ’¤é”€æˆæƒ

### 3. å®æ—¶é€šçŸ¥
- **è‡ªåŠ¨è¿æ¥**: ç™»å½•ç”¨æˆ·è‡ªåŠ¨å»ºç«‹WebSocketè¿æ¥
- **å¼ºåˆ¶ç™»å‡º**: å…¶ä»–è®¾å¤‡ç™»å‡ºæ—¶ç«‹å³æ”¶åˆ°é€šçŸ¥
- **ä¼˜é›…é™çº§**: æ”¯æŒSockJSåœ¨ä¸æ”¯æŒWebSocketæ—¶é™çº§

---

## ğŸ“ æ€»ç»“

çœŸæ­£çš„å•ç‚¹ç™»å‡ºå®ç°éœ€è¦ç»¼åˆè€ƒè™‘å››ä¸ªæ ¸å¿ƒæ–¹é¢ï¼š

1. **ä»¤ç‰Œæ’¤é”€æœºåˆ¶**: ç¡®ä¿OAuth2ä»¤ç‰Œåœ¨ç™»å‡ºåç«‹å³å¤±æ•ˆ
2. **ä¼šè¯åŒæ­¥é€šçŸ¥**: å®ç°è·¨è®¾å¤‡ã€è·¨æµè§ˆå™¨çš„ä¼šè¯ç»Ÿä¸€ç®¡ç†  
3. **è·¨åŸŸç™»å‡ºåè°ƒ**: æ”¯æŒå¤šç§ç™»å‡ºæ¨¡å¼ï¼Œæ»¡è¶³ä¸åŒå®‰å…¨éœ€æ±‚
4. **WebSocketå®æ—¶é€šçŸ¥**: æä¾›å³æ—¶çš„ç™»å‡ºé€šçŸ¥å’Œç”¨æˆ·ä½“éªŒ

é€šè¿‡è¿™å¥—å®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œå®ç°äº†çœŸæ­£æ„ä¹‰ä¸Šçš„å•ç‚¹ç™»å‡ºï¼Œä¸ºç”¨æˆ·æä¾›å®‰å…¨ã€ä¾¿æ·çš„è®¤è¯ä½“éªŒã€‚ 