<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿè°ƒè¯• - OAuth2 SSO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container my-5">
        <h2>
            <i class="bi bi-bug"></i>
            ç³»ç»Ÿè°ƒè¯•é¢æ¿
        </h2>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-info-circle"></i> ä¼šè¯çŠ¶æ€ä¿¡æ¯</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="checkSessionStatus()">
                            <i class="bi bi-arrow-clockwise"></i> æ£€æŸ¥ä¼šè¯çŠ¶æ€
                        </button>
                        <div id="sessionStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-tools"></i> æ‰‹åŠ¨æ“ä½œ</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-warning" onclick="registerSession()">
                            <i class="bi bi-plus-circle"></i> æ‰‹åŠ¨æ³¨å†Œå½“å‰ä¼šè¯
                        </button>
                        <button class="btn btn-success mt-2" onclick="testWebSocket()">
                            <i class="bi bi-broadcast"></i> æµ‹è¯•WebSocketè¿æ¥
                        </button>
                        <div id="operationResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-terminal"></i> å®æ—¶æ—¥å¿—</h5>
                    </div>
                    <div class="card-body">
                        <div id="logOutput" class="bg-dark text-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace;">
                            ç­‰å¾…æ—¥å¿—è¾“å‡º...
                        </div>
                        <button class="btn btn-secondary mt-2" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> æ¸…é™¤æ—¥å¿—
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <a href="/" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> è¿”å›é¦–é¡µ
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let websocket = null;
        
        function addLog(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.innerHTML += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logOutput').innerHTML = 'æ—¥å¿—å·²æ¸…é™¤\n';
        }
        
        async function checkSessionStatus() {
            addLog('ğŸ” æ£€æŸ¥ä¼šè¯çŠ¶æ€...');
            try {
                const response = await fetch('/debug/session-status');
                const data = await response.json();
                
                const statusDiv = document.getElementById('sessionStatus');
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <h6>ä¼šè¯çŠ¶æ€ä¿¡æ¯:</h6>
                        <ul class="mb-0">
                            <li><strong>ç”¨æˆ·å:</strong> ${data.username || 'N/A'}</li>
                            <li><strong>è®¤è¯ç±»å‹:</strong> ${data.authType || 'N/A'}</li>
                            <li><strong>SessionSyncä¼šè¯æ•°:</strong> ${data.syncServiceSessionCount}</li>
                            <li><strong>Registryä¼šè¯æ•°:</strong> ${data.registrySessionCount}</li>
                            <li><strong>WebSocketè¿æ¥æ•°:</strong> ${data.activeWebSocketCount}</li>
                        </ul>
                        <div class="mt-2">
                            <span class="badge bg-${data.syncServiceSessionCount > 0 ? 'success' : 'warning'}">
                                ${data.diagnosis}
                            </span>
                        </div>
                    </div>
                `;
                
                addLog(`âœ… ä¼šè¯çŠ¶æ€æ£€æŸ¥å®Œæˆ: ${data.diagnosis}`);
            } catch (error) {
                addLog(`âŒ æ£€æŸ¥ä¼šè¯çŠ¶æ€å¤±è´¥: ${error.message}`);
            }
        }
        
        async function registerSession() {
            addLog('ğŸ”§ æ‰‹åŠ¨æ³¨å†Œå½“å‰ä¼šè¯...');
            try {
                const response = await fetch('/debug/register-session');
                const data = await response.json();
                
                const resultDiv = document.getElementById('operationResult');
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <h6>æ³¨å†ŒæˆåŠŸ!</h6>
                            <p>ç”¨æˆ·: ${data.username}<br>
                               ä¼šè¯ID: ${data.sessionId}<br>
                               æ´»è·ƒä¼šè¯æ•°: ${data.activeSessionCount}</p>
                        </div>
                    `;
                    addLog(`âœ… ä¼šè¯æ³¨å†ŒæˆåŠŸ: ${data.username}`);
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>æ³¨å†Œå¤±è´¥!</h6>
                            <p>${data.message}</p>
                        </div>
                    `;
                    addLog(`âŒ ä¼šè¯æ³¨å†Œå¤±è´¥: ${data.message}`);
                }
            } catch (error) {
                addLog(`âŒ æ‰‹åŠ¨æ³¨å†Œä¼šè¯å¤±è´¥: ${error.message}`);
            }
        }
        
        function testWebSocket() {
            addLog('ğŸ”Œ æµ‹è¯•WebSocketè¿æ¥...');
            
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                addLog('âš ï¸ WebSocketå·²è¿æ¥ï¼Œå…³é—­ç°æœ‰è¿æ¥');
                websocket.close();
            }
            
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/logout`;
                
                addLog(`ğŸ”— è¿æ¥WebSocket: ${wsUrl}`);
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    addLog('âœ… WebSocketè¿æ¥æˆåŠŸ');
                    websocket.send('ping');
                };
                
                websocket.onmessage = function(event) {
                    addLog(`ğŸ“© æ”¶åˆ°WebSocketæ¶ˆæ¯: ${event.data}`);
                };
                
                websocket.onclose = function(event) {
                    addLog(`ğŸ”Œ WebSocketè¿æ¥å…³é—­: ${event.code} - ${event.reason}`);
                };
                
                websocket.onerror = function(error) {
                    addLog(`âŒ WebSocketé”™è¯¯: ${error}`);
                };
                
            } catch (error) {
                addLog(`âŒ åˆ›å»ºWebSocketè¿æ¥å¤±è´¥: ${error.message}`);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = function() {
            addLog('ğŸš€ è°ƒè¯•é¢æ¿å·²åŠ è½½');
            checkSessionStatus();
        };
    </script>
</body>
</html> 